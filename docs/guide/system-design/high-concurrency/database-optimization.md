# æ•°æ®åº“ä¼˜åŒ–

> **AIç”Ÿæˆå£°æ˜Ž**: æœ¬æ–‡æ¡£ç”±AIè¾…åŠ©ç”Ÿæˆï¼Œæ—¨åœ¨æä¾›æ•°æ®åº“ä¼˜åŒ–çš„åŸºç¡€çŸ¥è¯†å’Œå®žè·µæŒ‡å—ã€‚

## ðŸŽ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ,ä½ å°†èƒ½å¤Ÿ:

- ç†è§£æ•°æ®åº“åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æŒ‘æˆ˜
- æŽŒæ¡æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥
- äº†è§£è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨
- å­¦ä¹ æ•°æ®åº“è¿žæŽ¥æ± ä¼˜åŒ–

## ðŸ“š æ•°æ®åº“é«˜å¹¶å‘æŒ‘æˆ˜

### ä¸»è¦æŒ‘æˆ˜

1. **è¿žæŽ¥æ•°é™åˆ¶**: æ•°æ®åº“è¿žæŽ¥æ•°æœ‰é™,å¹¶å‘è¯·æ±‚å¤šæ—¶è¿žæŽ¥ä¸å¤Ÿ
2. **é”ç«žäº‰**: å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®åŒä¸€æ•°æ®å¯¼è‡´é”ç­‰å¾…
3. **ç£ç›˜I/O**: é¢‘ç¹çš„ç£ç›˜è¯»å†™æˆä¸ºç“¶é¢ˆ
4. **æŸ¥è¯¢æ€§èƒ½**: å¤æ‚æŸ¥è¯¢å’Œå…¨è¡¨æ‰«æå½±å“æ€§èƒ½

### æ€§èƒ½ç“¶é¢ˆç‚¹

- **CPU**: å¤æ‚è®¡ç®—å’ŒæŽ’åº
- **å†…å­˜**: ç¼“å†²æ± å’Œç¼“å­˜
- **ç£ç›˜**: æ•°æ®è¯»å†™I/O
- **ç½‘ç»œ**: æ•°æ®ä¼ è¾“å¸¦å®½

## ðŸ” æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•ä¼˜åŒ–

**ä½œç”¨**: åŠ é€ŸæŸ¥è¯¢,å‡å°‘å…¨è¡¨æ‰«æ

**ä¼˜åŒ–åŽŸåˆ™**:
- åœ¨WHEREã€JOINã€ORDER BYå­—æ®µä¸Šå»ºç«‹ç´¢å¼•
- é¿å…è¿‡å¤šç´¢å¼•(å½±å“å†™å…¥æ€§èƒ½)
- ä½¿ç”¨å¤åˆç´¢å¼•è¦†ç›–æŸ¥è¯¢
- å®šæœŸåˆ†æžç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
-- åˆ›å»ºç´¢å¼•ç¤ºä¾‹
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_order_user_time ON orders(user_id, create_time);

-- åˆ†æžç´¢å¼•ä½¿ç”¨
EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–æŠ€å·§**:
- é¿å…SELECT *,åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
- ä½¿ç”¨LIMITé™åˆ¶ç»“æžœé›†
- é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
- åˆç†ä½¿ç”¨JOIN,é¿å…ç¬›å¡å°”ç§¯

```sql
-- ä¼˜åŒ–å‰
SELECT * FROM orders WHERE YEAR(create_time) = 2024;

-- ä¼˜åŒ–åŽ
SELECT id, user_id, amount FROM orders 
WHERE create_time >= '2024-01-01' AND create_time < '2025-01-01';
```

### 3. è¡¨ç»“æž„ä¼˜åŒ–

- **å­—æ®µç±»åž‹**: é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»åž‹
- **å­—æ®µé•¿åº¦**: é¿å…è¿‡é•¿çš„VARCHAR
- **NULLå€¼**: å°½é‡å‡å°‘NULLå­—æ®µ
- **èŒƒå¼è®¾è®¡**: å¹³è¡¡èŒƒå¼å’ŒåèŒƒå¼

## ðŸ—ï¸ è¯»å†™åˆ†ç¦»

### åŽŸç†

å°†æ•°æ®åº“åˆ†ä¸ºä¸»åº“(å†™)å’Œä»Žåº“(è¯»),å†™æ“ä½œåœ¨ä¸»åº“,è¯»æ“ä½œåœ¨ä»Žåº“ã€‚

```
åº”ç”¨å±‚
  â”œâ”€â†’ ä¸»åº“(å†™)
  â””â”€â†’ ä»Žåº“(è¯»)
```

### ä¼˜ç‚¹

- åˆ†æ‹…è¯»åŽ‹åŠ›
- æé«˜æŸ¥è¯¢æ€§èƒ½
- æé«˜å¯ç”¨æ€§(ä»Žåº“æ•…éšœä¸å½±å“å†™)

### å®žçŽ°æ–¹å¼

#### 1. åº”ç”¨å±‚åˆ†ç¦»

```python
# ä¸»ä»Žæ•°æ®åº“é…ç½®
DATABASES = {
    'default': {  # ä¸»åº“(å†™)
        'ENGINE': 'django.db.backends.mysql',
        'HOST': 'master.db.com',
    },
    'slave': {  # ä»Žåº“(è¯»)
        'ENGINE': 'django.db.backends.mysql',
        'HOST': 'slave.db.com',
    }
}

# è¯»å†™åˆ†ç¦»è£…é¥°å™¨
def read_from_slave(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        with router.db_for_read():
            return func(*args, **kwargs)
    return wrapper

@read_from_slave
def get_user(user_id):
    return User.objects.get(id=user_id)
```

#### 2. ä¸­é—´ä»¶åˆ†ç¦»

- **MySQL Proxy**: MySQLå®˜æ–¹ä»£ç†
- **Atlas**: å¥‡è™Ž360å¼€æºçš„æ•°æ®åº“ä¸­é—´ä»¶
- **MyCat**: å¼€æºåˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶

### æ³¨æ„äº‹é¡¹

- **æ•°æ®å»¶è¿Ÿ**: ä¸»ä»Žå¤åˆ¶æœ‰å»¶è¿Ÿ,éœ€è¦è€ƒè™‘ä¸€è‡´æ€§
- **å†™åŽè¯»**: å†™æ“ä½œåŽç«‹å³è¯»å¯èƒ½éœ€è¦è¯»ä¸»åº“
- **æ•…éšœåˆ‡æ¢**: ä¸»åº“æ•…éšœæ—¶éœ€è¦åˆ‡æ¢åˆ°ä»Žåº“

## ðŸ“Š åˆ†åº“åˆ†è¡¨

### åž‚ç›´åˆ†åº“

æŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†æ•°æ®åº“ã€‚

```
ç”¨æˆ·åº“(user_db)
è®¢å•åº“(order_db)
å•†å“åº“(product_db)
```

### æ°´å¹³åˆ†è¡¨

æŒ‰æ•°æ®èŒƒå›´æˆ–å“ˆå¸Œå€¼æ‹†åˆ†è¡¨ã€‚

```
orders_0  (user_id % 4 = 0)
orders_1  (user_id % 4 = 1)
orders_2  (user_id % 4 = 2)
orders_3  (user_id % 4 = 3)
```

### åˆ†ç‰‡ç­–ç•¥

#### 1. èŒƒå›´åˆ†ç‰‡

```python
def get_shard_by_range(user_id):
    if user_id < 1000000:
        return 'shard_0'
    elif user_id < 2000000:
        return 'shard_1'
    else:
        return 'shard_2'
```

#### 2. å“ˆå¸Œåˆ†ç‰‡

```python
def get_shard_by_hash(user_id):
    shard_count = 4
    shard_index = user_id % shard_count
    return f'shard_{shard_index}'
```

#### 3. ä¸€è‡´æ€§å“ˆå¸Œ

é€‚åˆåŠ¨æ€æ‰©å®¹åœºæ™¯ã€‚

### åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶

- **ShardingSphere**: Apacheå¼€æºåˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶
- **MyCat**: æ•°æ®åº“åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶
- **TDDL**: é˜¿é‡Œå·´å·´åˆ†å¸ƒå¼æ•°æ®åº“æœåŠ¡

## ðŸ’¾ è¿žæŽ¥æ± ä¼˜åŒ–

### è¿žæŽ¥æ± å‚æ•°

- **æœ€å¤§è¿žæŽ¥æ•°**: max_connections
- **æœ€å°è¿žæŽ¥æ•°**: min_connections
- **è¿žæŽ¥è¶…æ—¶**: connection_timeout
- **ç©ºé—²è¶…æ—¶**: idle_timeout

### è¿žæŽ¥æ± é…ç½®ç¤ºä¾‹

```python
# HikariCPé…ç½®
config = {
    'jdbcUrl': 'jdbc:mysql://localhost:3306/mydb',
    'username': 'user',
    'password': 'password',
    'maximumPoolSize': 20,  # æœ€å¤§è¿žæŽ¥æ•°
    'minimumIdle': 5,  # æœ€å°ç©ºé—²è¿žæŽ¥
    'connectionTimeout': 30000,  # è¿žæŽ¥è¶…æ—¶
    'idleTimeout': 600000,  # ç©ºé—²è¶…æ—¶
    'maxLifetime': 1800000,  # è¿žæŽ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
}
```

### è¿žæŽ¥æ± ç›‘æŽ§

- æ´»è·ƒè¿žæŽ¥æ•°
- ç©ºé—²è¿žæŽ¥æ•°
- ç­‰å¾…è¿žæŽ¥çš„çº¿ç¨‹æ•°
- è¿žæŽ¥èŽ·å–æ—¶é—´

## ðŸš€ å…¶ä»–ä¼˜åŒ–ç­–ç•¥

### 1. æ‰¹é‡æ“ä½œ

```sql
-- æ‰¹é‡æ’å…¥
INSERT INTO users (name, email) VALUES
('user1', 'user1@example.com'),
('user2', 'user2@example.com'),
('user3', 'user3@example.com');
```

### 2. äº‹åŠ¡ä¼˜åŒ–

- å‡å°‘äº‹åŠ¡æ—¶é—´
- é¿å…é•¿äº‹åŠ¡
- åˆç†ä½¿ç”¨äº‹åŠ¡éš”ç¦»çº§åˆ«

### 3. ç¼“å­˜æŸ¥è¯¢ç»“æžœ

- ç¼“å­˜çƒ­ç‚¹æ•°æ®
- ç¼“å­˜ç»Ÿè®¡ç»“æžœ
- é¿å…é‡å¤æŸ¥è¯¢

### 4. æ•°æ®åº“å‚æ•°è°ƒä¼˜

- **ç¼“å†²æ± å¤§å°**: innodb_buffer_pool_size
- **æ—¥å¿—æ–‡ä»¶å¤§å°**: innodb_log_file_size
- **æŸ¥è¯¢ç¼“å­˜**: query_cache_size(MySQL 5.7å·²ç§»é™¤)

## ðŸ“– æŽ¨èèµ„æº

- [MySQLæ€§èƒ½ä¼˜åŒ–](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
- [ShardingSphereå®˜æ–¹æ–‡æ¡£](https://shardingsphere.apache.org/document/current/cn/overview/)
- ã€Šé«˜æ€§èƒ½MySQLã€‹ä¹¦ç±

## ðŸ’¡ ä¸‹ä¸€æ­¥

- å­¦ä¹ [é™æµä¸Žç†”æ–­](./rate-limiting-circuit-breaker.md)
- äº†è§£[é«˜å¹¶å‘æž¶æž„è®¾è®¡](./architecture-design.md)

---

*æœ€åŽæ›´æ–°æ—¶é—´: 2025-01-20*

