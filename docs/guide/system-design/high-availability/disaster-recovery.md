# å®¹ç¾å¤‡ä»½

> **AIç”Ÿæˆå£°æ˜**: æœ¬æ–‡æ¡£ç”±AIè¾…åŠ©ç”Ÿæˆï¼Œæ—¨åœ¨æä¾›å®¹ç¾å¤‡ä»½çš„åŸºç¡€çŸ¥è¯†å’Œå®è·µæŒ‡å—ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ,ä½ å°†èƒ½å¤Ÿ:

- ç†è§£å®¹ç¾å¤‡ä»½çš„æ¦‚å¿µå’Œé‡è¦æ€§
- æŒæ¡æ•°æ®å¤‡ä»½ç­–ç•¥
- äº†è§£ç¾å¤‡æ¶æ„è®¾è®¡
- å­¦ä¹ ç¾å¤‡æ¼”ç»ƒå’Œæ¢å¤æµç¨‹

## ğŸ“š ä»€ä¹ˆæ˜¯å®¹ç¾å¤‡ä»½

å®¹ç¾å¤‡ä»½(Disaster Recovery)æ˜¯æŒ‡ä¸ºäº†åº”å¯¹ç¾éš¾æ€§äº‹ä»¶,ä¿è¯æ•°æ®å’Œä¸šåŠ¡èƒ½å¤Ÿå¿«é€Ÿæ¢å¤çš„ä¸€ç³»åˆ—æŠ€æœ¯å’Œç®¡ç†æªæ–½ã€‚

### å®¹ç¾çº§åˆ«

#### 1. æ•°æ®çº§å®¹ç¾

- **ç‰¹ç‚¹**: åªå¤‡ä»½æ•°æ®,æ¢å¤æ—¶éœ€è¦é‡æ–°éƒ¨ç½²ç³»ç»Ÿ
- **æˆæœ¬**: ä½
- **æ¢å¤æ—¶é—´**: è¾ƒé•¿(æ•°å°æ—¶åˆ°æ•°å¤©)
- **RPO**: æ•°å°æ—¶
- **RTO**: æ•°å°æ—¶åˆ°æ•°å¤©

#### 2. åº”ç”¨çº§å®¹ç¾

- **ç‰¹ç‚¹**: å¤‡ä»½æ•°æ®å’Œåº”ç”¨ç³»ç»Ÿ
- **æˆæœ¬**: ä¸­ç­‰
- **æ¢å¤æ—¶é—´**: ä¸­ç­‰(æ•°åˆ†é’Ÿåˆ°æ•°å°æ—¶)
- **RPO**: æ•°åˆ†é’Ÿåˆ°æ•°å°æ—¶
- **RTO**: æ•°åˆ†é’Ÿåˆ°æ•°å°æ—¶

#### 3. ä¸šåŠ¡çº§å®¹ç¾

- **ç‰¹ç‚¹**: å®Œæ•´çš„ä¸šåŠ¡ç³»ç»Ÿå¤‡ä»½,å¯å¿«é€Ÿåˆ‡æ¢
- **æˆæœ¬**: é«˜
- **æ¢å¤æ—¶é—´**: çŸ­(æ•°åˆ†é’Ÿ)
- **RPO**: æ•°åˆ†é’Ÿ
- **RTO**: æ•°åˆ†é’Ÿ

## ğŸ” å¤‡ä»½ç­–ç•¥

### å¤‡ä»½ç±»å‹

#### 1. å…¨é‡å¤‡ä»½

å¤‡ä»½æ‰€æœ‰æ•°æ®,é€‚åˆé¦–æ¬¡å¤‡ä»½ã€‚

**ä¼˜ç‚¹**: æ¢å¤ç®€å•
**ç¼ºç‚¹**: è€—æ—¶ã€å ç”¨ç©ºé—´å¤§

```bash
# MySQLå…¨é‡å¤‡ä»½
mysqldump -u root -p --all-databases > backup_full.sql

# å‹ç¼©å¤‡ä»½
mysqldump -u root -p --all-databases | gzip > backup_full.sql.gz
```

#### 2. å¢é‡å¤‡ä»½

åªå¤‡ä»½è‡ªä¸Šæ¬¡å¤‡ä»½åå˜åŒ–çš„æ•°æ®ã€‚

**ä¼˜ç‚¹**: é€Ÿåº¦å¿«ã€å ç”¨ç©ºé—´å°
**ç¼ºç‚¹**: æ¢å¤æ—¶éœ€è¦å¤šä¸ªå¤‡ä»½æ–‡ä»¶

```bash
# MySQLå¢é‡å¤‡ä»½(åŸºäºbinlog)
mysqlbinlog --start-datetime="2024-01-01 00:00:00" \
  --stop-datetime="2024-01-02 00:00:00" \
  mysql-bin.000001 > backup_incremental.sql
```

#### 3. å·®å¼‚å¤‡ä»½

å¤‡ä»½è‡ªä¸Šæ¬¡å…¨é‡å¤‡ä»½åå˜åŒ–çš„æ•°æ®ã€‚

**ä¼˜ç‚¹**: å¹³è¡¡é€Ÿåº¦å’Œç©ºé—´
**ç¼ºç‚¹**: æ¢å¤éœ€è¦å…¨é‡+å·®å¼‚å¤‡ä»½

### å¤‡ä»½ç­–ç•¥å»ºè®®

#### 3-2-1å¤‡ä»½ç­–ç•¥

- **3ä»½å¤‡ä»½**: 3ä»½æ•°æ®å‰¯æœ¬
- **2ç§ä»‹è´¨**: è‡³å°‘2ç§ä¸åŒçš„å­˜å‚¨ä»‹è´¨
- **1ä»½å¼‚åœ°**: è‡³å°‘1ä»½å¼‚åœ°å¤‡ä»½

#### å¤‡ä»½å‘¨æœŸ

```
æ¯æ—¥å¢é‡å¤‡ä»½
æ¯å‘¨å…¨é‡å¤‡ä»½
æ¯æœˆå½’æ¡£å¤‡ä»½
```

## ğŸ—ï¸ ç¾å¤‡æ¶æ„

### åŒåŸç¾å¤‡

åœ¨åŒä¸€åŸå¸‚çš„ä¸åŒæœºæˆ¿éƒ¨ç½²å¤‡ä»½ç³»ç»Ÿã€‚

```
ä¸»æ•°æ®ä¸­å¿ƒ(æœºæˆ¿A)
  â†“ (åŒæ­¥)
å¤‡æ•°æ®ä¸­å¿ƒ(æœºæˆ¿B) - åŒä¸€åŸå¸‚
```

**ç‰¹ç‚¹**:
- å»¶è¿Ÿä½(<10ms)
- å¸¦å®½æˆæœ¬ä½
- æ— æ³•åº”å¯¹åŒºåŸŸæ€§ç¾éš¾

### å¼‚åœ°ç¾å¤‡

åœ¨ä¸åŒåŸå¸‚éƒ¨ç½²å¤‡ä»½ç³»ç»Ÿã€‚

```
ä¸»æ•°æ®ä¸­å¿ƒ(åŸå¸‚A)
  â†“ (å¼‚æ­¥åŒæ­¥)
å¤‡æ•°æ®ä¸­å¿ƒ(åŸå¸‚B) - ä¸åŒåŸå¸‚
```

**ç‰¹ç‚¹**:
- å¯åº”å¯¹åŒºåŸŸæ€§ç¾éš¾
- å»¶è¿Ÿè¾ƒé«˜(>50ms)
- å¸¦å®½æˆæœ¬é«˜

### å¤šæ´»æ¶æ„

å¤šä¸ªæ•°æ®ä¸­å¿ƒåŒæ—¶æä¾›æœåŠ¡ã€‚

```
æ•°æ®ä¸­å¿ƒA(Active) â†â†’ æ•°æ®ä¸­å¿ƒB(Active)
      åŒå‘åŒæ­¥
```

**ç‰¹ç‚¹**:
- æ— ä¸»å¤‡ä¹‹åˆ†
- èµ„æºåˆ©ç”¨ç‡é«˜
- æ•°æ®ä¸€è‡´æ€§å¤æ‚

## ğŸ’¾ æ•°æ®å¤‡ä»½æŠ€æœ¯

### æ•°æ®åº“å¤‡ä»½

#### MySQLå¤‡ä»½

```bash
# 1. é€»è¾‘å¤‡ä»½(mysqldump)
mysqldump -u root -p \
  --single-transaction \
  --master-data=2 \
  --flush-logs \
  database_name > backup.sql

# 2. ç‰©ç†å¤‡ä»½(Percona XtraBackup)
xtrabackup --backup \
  --target-dir=/backup/mysql/ \
  --user=root --password=xxx

# 3. ä¸»ä»å¤åˆ¶(å®æ—¶å¤‡ä»½)
CHANGE MASTER TO
  MASTER_HOST='slave_ip',
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=107;
```

#### Rediså¤‡ä»½

```bash
# RDBå¿«ç…§å¤‡ä»½
redis-cli --rdb /backup/redis/dump.rdb

# AOFæŒä¹…åŒ–å¤‡ä»½
# åœ¨redis.confä¸­é…ç½®
appendonly yes
appendfsync everysec
```

### æ–‡ä»¶å¤‡ä»½

#### rsyncåŒæ­¥

```bash
# åŒæ­¥å¤‡ä»½
rsync -avz --delete \
  /source/directory/ \
  user@backup-server:/backup/directory/

# å®šæ—¶å¤‡ä»½(é…åˆcron)
0 2 * * * rsync -avz /data/ user@backup:/backup/
```

#### å¯¹è±¡å­˜å‚¨å¤‡ä»½

```python
import boto3

s3 = boto3.client('s3')

# ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
s3.upload_file(
    '/local/backup/file.tar.gz',
    'backup-bucket',
    'backups/file.tar.gz'
)

# è®¾ç½®ç”Ÿå‘½å‘¨æœŸç­–ç•¥(è‡ªåŠ¨åˆ é™¤æ—§å¤‡ä»½)
s3.put_bucket_lifecycle_configuration(
    Bucket='backup-bucket',
    LifecycleConfiguration={
        'Rules': [{
            'Id': 'Delete old backups',
            'Status': 'Enabled',
            'Expiration': {'Days': 90}
        }]
    }
)
```

## ğŸš€ æ¢å¤æµç¨‹

### æ¢å¤æ­¥éª¤

1. **è¯„ä¼°æŸå¤±**: è¯„ä¼°æ•°æ®ä¸¢å¤±èŒƒå›´
2. **é€‰æ‹©å¤‡ä»½**: é€‰æ‹©æœ€è¿‘çš„å¯ç”¨å¤‡ä»½
3. **æ¢å¤æ•°æ®**: æ‰§è¡Œæ•°æ®æ¢å¤
4. **éªŒè¯æ•°æ®**: éªŒè¯æ•°æ®å®Œæ•´æ€§
5. **åˆ‡æ¢æœåŠ¡**: åˆ‡æ¢åˆ°æ¢å¤çš„ç³»ç»Ÿ
6. **éªŒè¯åŠŸèƒ½**: éªŒè¯ä¸šåŠ¡åŠŸèƒ½æ­£å¸¸

### MySQLæ¢å¤ç¤ºä¾‹

```bash
# 1. åœæ­¢MySQLæœåŠ¡
systemctl stop mysql

# 2. æ¢å¤å…¨é‡å¤‡ä»½
mysql -u root -p < backup_full.sql

# 3. æ¢å¤å¢é‡å¤‡ä»½
mysqlbinlog backup_incremental.000001 | mysql -u root -p
mysqlbinlog backup_incremental.000002 | mysql -u root -p

# 4. å¯åŠ¨MySQLæœåŠ¡
systemctl start mysql

# 5. éªŒè¯æ•°æ®
mysql -u root -p -e "SELECT COUNT(*) FROM database.table;"
```

### è‡ªåŠ¨æ¢å¤è„šæœ¬

```python
#!/usr/bin/env python3
import subprocess
import boto3
from datetime import datetime

def restore_from_backup(backup_file, database):
    """ä»å¤‡ä»½æ¢å¤æ•°æ®åº“"""
    print(f"å¼€å§‹æ¢å¤æ•°æ®åº“: {database}")
    
    # 1. ä¸‹è½½å¤‡ä»½æ–‡ä»¶
    s3 = boto3.client('s3')
    local_file = f"/tmp/{backup_file}"
    s3.download_file('backup-bucket', backup_file, local_file)
    
    # 2. æ¢å¤æ•°æ®åº“
    cmd = f"mysql -u root -p {database} < {local_file}"
    result = subprocess.run(cmd, shell=True, capture_output=True)
    
    if result.returncode == 0:
        print(f"æ•°æ®åº“æ¢å¤æˆåŠŸ: {database}")
        # éªŒè¯æ•°æ®
        verify_data(database)
    else:
        print(f"æ•°æ®åº“æ¢å¤å¤±è´¥: {result.stderr}")
        raise Exception("æ¢å¤å¤±è´¥")

def verify_data(database):
    """éªŒè¯æ•°æ®å®Œæ•´æ€§"""
    # æ£€æŸ¥å…³é”®è¡¨è®°å½•æ•°
    tables = ['users', 'orders', 'products']
    for table in tables:
        cmd = f"mysql -u root -p {database} -e 'SELECT COUNT(*) FROM {table}'"
        result = subprocess.run(cmd, shell=True, capture_output=True)
        print(f"è¡¨ {table} è®°å½•æ•°: {result.stdout.decode()}")
```

## ğŸ“Š ç¾å¤‡æ¼”ç»ƒ

### æ¼”ç»ƒç±»å‹

#### 1. æ¡Œé¢æ¼”ç»ƒ

åœ¨ä¼šè®®å®¤è®¨è®ºç¾å¤‡æµç¨‹,ä¸å®é™…æ‰§è¡Œã€‚

**ä¼˜ç‚¹**: æˆæœ¬ä½ã€é£é™©å°
**ç¼ºç‚¹**: æ— æ³•å‘ç°å®é™…é—®é¢˜

#### 2. éƒ¨åˆ†æ¼”ç»ƒ

æ¼”ç»ƒéƒ¨åˆ†ç¾å¤‡æµç¨‹,å¦‚æ•°æ®æ¢å¤ã€‚

**ä¼˜ç‚¹**: éªŒè¯å…³é”®æµç¨‹
**ç¼ºç‚¹**: è¦†ç›–ä¸å…¨é¢

#### 3. å…¨é‡æ¼”ç»ƒ

å®Œæ•´æ¼”ç»ƒç¾å¤‡æµç¨‹,åŒ…æ‹¬åˆ‡æ¢ã€‚

**ä¼˜ç‚¹**: å…¨é¢éªŒè¯
**ç¼ºç‚¹**: æˆæœ¬é«˜ã€é£é™©å¤§

### æ¼”ç»ƒé¢‘ç‡

- **å…³é”®ç³»ç»Ÿ**: æ¯å­£åº¦ä¸€æ¬¡
- **é‡è¦ç³»ç»Ÿ**: æ¯åŠå¹´ä¸€æ¬¡
- **ä¸€èˆ¬ç³»ç»Ÿ**: æ¯å¹´ä¸€æ¬¡

### æ¼”ç»ƒæ£€æŸ¥æ¸…å•

- [ ] å¤‡ä»½æ•°æ®å®Œæ•´æ€§
- [ ] æ¢å¤æ—¶é—´ç¬¦åˆRTOè¦æ±‚
- [ ] æ•°æ®ä¸¢å¤±åœ¨RPOèŒƒå›´å†…
- [ ] æ¢å¤æµç¨‹æ–‡æ¡£å®Œæ•´
- [ ] ç›¸å…³äººå‘˜ç†Ÿæ‚‰æµç¨‹
- [ ] åº”æ€¥è”ç³»æ–¹å¼æœ‰æ•ˆ

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¤‡ä»½éªŒè¯

- å®šæœŸéªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
- æµ‹è¯•æ¢å¤æµç¨‹
- æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¯è¯»æ€§

### 2. å¤‡ä»½å®‰å…¨

- å¤‡ä»½æ–‡ä»¶åŠ å¯†å­˜å‚¨
- è®¿é—®æƒé™æ§åˆ¶
- å¼‚åœ°å¤‡ä»½é˜²æ­¢ä¸¢å¤±

### 3. æˆæœ¬æ§åˆ¶

- é€‰æ‹©åˆé€‚çš„å¤‡ä»½ç­–ç•¥
- å®šæœŸæ¸…ç†è¿‡æœŸå¤‡ä»½
- ä½¿ç”¨å‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´

## ğŸ“– æ¨èèµ„æº

- [AWSç¾éš¾æ¢å¤æŒ‡å—](https://aws.amazon.com/disaster-recovery/)
- ã€Šæ•°æ®å¤‡ä»½ä¸æ¢å¤ã€‹ä¹¦ç±
- [MySQLå¤‡ä»½ä¸æ¢å¤](https://dev.mysql.com/doc/refman/8.0/en/backup-and-recovery.html)

## ğŸ’¡ ä¸‹ä¸€æ­¥

- å­¦ä¹ [æ•…éšœè½¬ç§»](./failover.md)æœºåˆ¶
- äº†è§£[æœåŠ¡é™çº§](./degradation.md)æ–¹æ¡ˆ
- æŒæ¡[é«˜å¯ç”¨æ¶æ„è®¾è®¡](./architecture-design.md)

---

*æœ€åæ›´æ–°æ—¶é—´: 2025-01-20*

